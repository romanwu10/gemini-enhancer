// Copy of the first 1953 lines to preserve the working code